<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UrbanMind: Document Filling Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/legal.css">
</head>
<body>
<div id="header-container"></div>

<section class="hero" id="home">
    <div class="hero-bg">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
    </div>

    <div class="container hero-content">
        <div class="hero-text fade-in">
            <h1>AI Document Filling Assistant</h1>
            <p>Upload your blank forms and watch as our AI automatically fills them out with the correct information. All processing happens locally on your device.</p>
            <a href="#assistant" class="btn-main">Try Document Assistant</a>
        </div>
        <div class="robot-container fade-in">
            <img src="../img/riter.png" alt="AI Assistant Robot" class="robot-image" style="max-width: 300px;">
        </div>
    </div>
</section>

<section class="security-section">
    <div class="security-bg"></div>
    <div class="container">
        <div class="security-notice fade-in">
            <h3><i class="fas fa-shield-alt"></i> Your Privacy & Security</h3>
            <p><strong>All document processing happens locally in your browser.</strong> Your files never leave your device or get sent to our servers. We don't store any of your personal information or documents.</p>
        </div>
    </div>
</section>

<section class="document-assistant" id="assistant">
    <div class="container">
        <h2 class="sections-heading">Document Filling Assistant</h2>
        <div class="assistant-container">
            <!-- Input Panel -->
            <div class="panel fade-in">
                <div class="panel-header">
                    <h3><i class="fas fa-upload"></i> Upload Documents</h3>
                </div>
                <div class="panel-content">
                    <div class="upload-area" id="upload-area">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h4>Upload Documents</h4>
                        <p>Upload exactly 2 files: blank form template and your passport/ID document</p>
                        <div class="upload-button">Select Files</div>
                        <input type="file" id="file-input" class="file-input" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.txt" multiple>
                    </div>

                    <div id="uploaded-files">
                        <!-- Uploaded files will appear here -->
                    </div>

                    <div class="document-actions">
                        <button class="document-action" id="process-btn" disabled>
                            <i class="fas fa-magic"></i> Fill Documents Automatically
                        </button>
                        <span id="fill-status" style="font-size:0.85rem;color:#4b5563;margin-left:1rem;"></span>
                    </div>
                    <p style="margin-top:0.75rem;font-size:0.85rem;color:#6b7280;">For best results: first upload the blank form, then your passport/ID document.</p>
                </div>
            </div>

            <!-- Output Panel -->
            <div class="panel fade-in">
                <div class="panel-header">
                    <h3><i class="fas fa-file-contract"></i> Filled Documents</h3>
                </div>
                <div class="panel-content">
                    <div class="document-preview">
                        <div class="preview-header">
                            <h4>Filled Form Preview</h4>
                            <span id="document-count">0 documents</span>
                        </div>
                        <div class="preview-content" id="preview-content">
                            <div class="preview-placeholder">
                                <i class="fas fa-file-alt"></i>
                                <p>Upload blank form and your document to see them automatically filled out</p>
                            </div>
                        </div>
                        <div style="padding:1rem;border-top:1px solid rgba(148,163,184,0.3);display:none;" id="result-details">
                            <div style="margin-bottom:0.75rem;">
                                <strong style="font-size:0.85rem;">Missing fields</strong>
                                <ul id="missing-fields-list" style="margin:0.25rem 0 0;padding-left:1.25rem;font-size:0.8rem;color:#6b7280;"></ul>
                            </div>
                            <div>
                                <strong style="font-size:0.85rem;">Notes</strong>
                                <p id="notes-text" style="margin:0.25rem 0 0;font-size:0.8rem;color:#6b7280;">No notes yet.</p>
                            </div>
                        </div>
                    </div>

                    <div class="document-actions">
                        <button class="document-action" id="copy-filled-btn" style="display:none;">
                            <i class="fas fa-copy"></i> Copy Filled Text
                        </button>
                        <button class="document-action" id="download-filled-btn" style="display:none;">
                            <i class="fas fa-download"></i> Download As TXT
                        </button>
                        <button class="document-action secondary" id="clear-all-btn">
                            <i class="fas fa-trash-alt"></i> Clear All
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<footer class="footer">
    <div class="container">
        <h2>Try Our Secure Document Assistant</h2>
        <p>Process your immigration documents safely with our local AI assistant.</p>
        <a href="#assistant" class="btn-footer">Start Filling Documents</a>
    </div>
</footer>

<script>
    fetch('/header.html')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.text();
        })
        .then(html => {
            document.getElementById('header-container').innerHTML = html;
        })
        .catch(error => {
            document.getElementById('header-container').innerHTML =
                `<div style="color: red;">Error loading header: ${error.message}</div>`;
        });

    // Document Assistant functionality
    const fileInput = document.getElementById('file-input');
    const uploadArea = document.getElementById('upload-area');
    const uploadedFiles = document.getElementById('uploaded-files');
    const processBtn = document.getElementById('process-btn');
    const clearAllBtn = document.getElementById('clear-all-btn');
    const previewContent = document.getElementById('preview-content');
    const documentCount = document.getElementById('document-count');
    const fillStatus = document.getElementById('fill-status');
    const missingFieldsList = document.getElementById('missing-fields-list');
    const notesText = document.getElementById('notes-text');
    const copyFilledBtn = document.getElementById('copy-filled-btn');
    const downloadFilledBtn = document.getElementById('download-filled-btn');
    const resultDetails = document.getElementById('result-details');

    let uploadedDocuments = [];
    let filledFormText = '';

    // File upload handling
    uploadArea.addEventListener('click', () => {
        fileInput.click();
    });

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = 'var(--color-primary-blue)';
        uploadArea.style.backgroundColor = '#f0f4ff';
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.style.borderColor = '#e0e0e0';
        uploadArea.style.backgroundColor = 'transparent';
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '#e0e0e0';
        uploadArea.style.backgroundColor = 'transparent';

        if (e.dataTransfer.files.length) {
            handleFileUpload(Array.from(e.dataTransfer.files));
        }
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length) {
            handleFileUpload(Array.from(e.target.files));
        }
    });

    function handleFileUpload(files) {
        Array.from(files).forEach(file => {
            // Validate file type
            const validTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png',
                'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'text/plain', 'text/html', 'text/markdown'];

            if (!validTypes.includes(file.type) && !file.name.match(/\.(pdf|jpg|jpeg|png|doc|docx|txt|md|html)$/i)) {
                alert('Please upload PDF, image, Word, or text documents only.');
                return;
            }

            // Check file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('File size too large. Please upload files smaller than 10MB.');
                return;
            }

            // Add to uploaded documents
            uploadedDocuments.push(file);
            displayUploadedFile(file);
        });

        // Enable process button if we have at least 2 documents
        if (uploadedDocuments.length >= 2) {
            processBtn.disabled = false;
            fillStatus.textContent = 'Ready to process. Click "Fill Documents Automatically" to start.';
            fillStatus.style.color = '#16a34a';
        } else if (uploadedDocuments.length === 1) {
            fillStatus.textContent = 'Upload one more document (passport/ID) to proceed.';
            fillStatus.style.color = '#f59e0b';
        } else {
            fillStatus.textContent = '';
        }

        updateDocumentCount();
    }

    function displayUploadedFile(file) {
        const fileElement = document.createElement('div');
        fileElement.className = 'uploaded-file';
        fileElement.innerHTML = `
            <div class="file-icon">
                <i class="fas fa-file-pdf"></i>
            </div>
            <div class="file-info">
                <div class="file-name">${file.name}</div>
                <div class="file-size">${formatFileSize(file.size)}</div>
            </div>
            <div class="file-actions">
                <button class="file-action preview" title="Preview">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="file-action remove" title="Remove">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;

        // Remove file functionality
        fileElement.querySelector('.remove').addEventListener('click', () => {
            const index = uploadedDocuments.findIndex(doc => doc.name === file.name);
            if (index !== -1) {
                uploadedDocuments.splice(index, 1);
            }
            fileElement.remove();

            if (uploadedDocuments.length < 2) {
                processBtn.disabled = true;
                fillStatus.textContent = uploadedDocuments.length === 1 ? 'Upload one more document to proceed.' : '';
                fillStatus.style.color = uploadedDocuments.length === 1 ? '#f59e0b' : '';
            }
            updateDocumentCount();
        });

        // Preview file functionality
        fileElement.querySelector('.preview').addEventListener('click', () => {
            previewDocument(file);
        });

        uploadedFiles.appendChild(fileElement);
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' bytes';
        else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
        else return (bytes / 1048576).toFixed(1) + ' MB';
    }

    function updateDocumentCount() {
        documentCount.textContent = `${uploadedDocuments.length} document${uploadedDocuments.length !== 1 ? 's' : ''}`;
    }

    function previewDocument(file) {
        // In a real application, this would show a proper preview
        // For demo, we'll just show a placeholder with file info
        previewContent.innerHTML = `
            <div class="preview-document">
                <div class="document-image">
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-file-pdf" style="font-size: 4em; color: #e0e0e0; margin-bottom: 15px;"></i>
                        <h4>${file.name}</h4>
                        <p>${formatFileSize(file.size)}</p>
                        <p style="margin-top: 20px; color: var(--color-light-text);">Document preview would appear here</p>
                    </div>
                </div>
            </div>
        `;
    }

    // Process documents
    processBtn.addEventListener('click', () => {
        if (uploadedDocuments.length < 2) {
            fillStatus.textContent = 'Please upload at least 2 documents: blank form and your passport/ID.';
            fillStatus.style.color = '#b91c1c';
            return;
        }

        callFillFormAPI();
    });

    function callFillFormAPI() {
        const templateFile = uploadedDocuments[0];
        const userDocumentFile = uploadedDocuments[1];

        // Show processing indicator
        previewContent.innerHTML = `
            <div class="processing-indicator" style="text-align:center;padding:2rem;">
                <i class="fas fa-spinner fa-spin" style="font-size:2rem;color:#4f46e5;margin-bottom:1rem;"></i>
                <p>Processing documents with AI...</p>
                <p style="font-size:0.85rem;color:#6b7280;margin-top:0.5rem;">This may take a few moments</p>
            </div>
        `;
        resultDetails.style.display = 'none';
        copyFilledBtn.style.display = 'none';
        downloadFilledBtn.style.display = 'none';
        fillStatus.textContent = 'Processing...';
        fillStatus.style.color = '#2563eb';
        processBtn.disabled = true;
        clearAllBtn.disabled = true;

        const formData = new FormData();
        formData.append('template_file', templateFile);
        formData.append('user_document_file', userDocumentFile);
        formData.append('language', 'en');

        fetch('/api/fill_form', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    try {
                        const err = JSON.parse(text);
                        throw new Error(err.detail || `HTTP error ${response.status}`);
                    } catch (e) {
                        throw new Error(text || `HTTP error ${response.status}`);
                    }
                });
            }
            
            // Get metadata from headers
            const missingFieldsHeader = response.headers.get('X-Missing-Fields') || '[]';
            const notesHeader = response.headers.get('X-Notes') || '';
            const contentDisposition = response.headers.get('Content-Disposition') || '';
            let filename = 'filled_form.pdf';
            if (contentDisposition) {
                const match = contentDisposition.match(/filename="(.+)"/);
                if (match) {
                    filename = match[1];
                }
            }
            
            // Parse missing fields
            let missingFields = [];
            try {
                missingFields = JSON.parse(missingFieldsHeader);
            } catch (e) {
                console.error('Failed to parse missing fields:', e);
            }
            
            // Return blob and metadata
            return response.blob().then(blob => ({
                blob: blob,
                filename: filename,
                missingFields: missingFields,
                notes: notesHeader
            }));
        })
        .then(data => {
            console.log('API response received:', data);
            
            // Automatically download the PDF
            const url = URL.createObjectURL(data.blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = data.filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Display success message with PDF preview
            previewContent.innerHTML = `
                <div style="text-align:center;padding:2rem;">
                    <i class="fas fa-check-circle" style="font-size:3rem;color:#16a34a;margin-bottom:1rem;"></i>
                    <h3 style="color:#16a34a;margin-bottom:0.5rem;">Form Filled Successfully!</h3>
                    <p style="color:#6b7280;margin-bottom:1.5rem;">Your filled PDF has been downloaded automatically.</p>
                    <div style="background:#f8fafc;border-radius:12px;padding:1rem;border:1px dashed #cbd5f5;display:inline-block;">
                        <i class="fas fa-file-pdf" style="font-size:2rem;color:#ef4444;margin-bottom:0.5rem;"></i>
                        <p style="font-size:0.85rem;color:#0f172a;margin:0;">${data.filename}</p>
                    </div>
                </div>
            `;

            // Display missing fields
            missingFieldsList.innerHTML = '';
            if (data.missingFields && data.missingFields.length > 0) {
                data.missingFields.forEach(field => {
                    const li = document.createElement('li');
                    li.textContent = field;
                    missingFieldsList.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.textContent = 'No missing fields detected.';
                li.style.color = '#16a34a';
                missingFieldsList.appendChild(li);
            }

            // Display notes
            notesText.textContent = data.notes || 'The form was filled based on the available data.';

            resultDetails.style.display = 'block';
            copyFilledBtn.style.display = 'none'; // Hide copy button since we have PDF
            downloadFilledBtn.style.display = 'inline-flex'; // Keep download button for re-download
            downloadFilledBtn.onclick = () => {
                const url = URL.createObjectURL(data.blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = data.filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };
            
            fillStatus.textContent = 'Completed successfully! PDF downloaded.';
            fillStatus.style.color = '#16a34a';
            documentCount.textContent = '1 filled document';
        })
        .catch(error => {
            console.error('Error:', error);
            previewContent.innerHTML = `
                <div style="text-align:center;padding:2rem;color:#b91c1c;">
                    <i class="fas fa-exclamation-circle" style="font-size:2rem;margin-bottom:1rem;"></i>
                    <p><strong>Error processing documents</strong></p>
                    <p style="font-size:0.85rem;margin-top:0.5rem;">${error.message}</p>
                </div>
            `;
            fillStatus.textContent = `Error: ${error.message}`;
            fillStatus.style.color = '#b91c1c';
        })
        .finally(() => {
            processBtn.disabled = false;
            clearAllBtn.disabled = false;
        });
    }

    // Download button will be set dynamically in callFillFormAPI

    // Clear all documents
    clearAllBtn.addEventListener('click', () => {
        uploadedDocuments = [];
        filledFormText = '';
        uploadedFiles.innerHTML = '';
        previewContent.innerHTML = `
            <div class="preview-placeholder">
                <i class="fas fa-file-alt"></i>
                <p>Upload blank form and your document to see them automatically filled out</p>
            </div>
        `;
        resultDetails.style.display = 'none';
        copyFilledBtn.style.display = 'none';
        downloadFilledBtn.style.display = 'none';
        processBtn.disabled = true;
        fillStatus.textContent = '';
        missingFieldsList.innerHTML = '';
        notesText.textContent = 'No notes yet.';
        updateDocumentCount();
    });

    // Mobile menu toggle
    const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
    const navMenu = document.querySelector('.nav-menu');

    if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener('click', () => {
            navMenu.classList.toggle('active');
            mobileMenuBtn.innerHTML = navMenu.classList.contains('active')
                ? '<i class="fas fa-times"></i>'
                : '<i class="fas fa-bars"></i>';
        });
    }

    // Smooth scrolling for navigation links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
</script>
</body>
</html>