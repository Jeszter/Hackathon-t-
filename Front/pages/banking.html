<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UrbanMind: Smart Form Filling</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/banking.css">
</head>
<body>
<div id="header-container"></div>

<section class="hero" id="home">
    <span class="hero-decoration plus-top">x</span>
    <span class="hero-decoration circle-mid">o</span>
    <span class="hero-decoration plus-bottom">+</span>

    <div class="hero-bg">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <div class="decoration-circle circle-1"></div>
    <div class="decoration-circle circle-2"></div>
    <div class="decoration-circle circle-3"></div>

    <div class="dots-pattern dots-1"></div>
    <div class="dots-pattern dots-2"></div>

    <div class="container hero-content">
        <div class="hero-text fade-in">
            <h1>Fill Official Forms Automatically</h1>
            <p>Upload a blank form and a document with your data. Our AI will fill in the form for you and show any missing fields.</p>
            <a href="#documents-section" class="btn-main">Start Filling Forms</a>
        </div>
        <div class="robot-container fade-in">
            <div class="robot-bg"></div>
            <img src="../img/banking.png" alt="AI Assistant Robot" class="robot-image">
        </div>
    </div>
</section>

<section class="location-detection" id="documents-section">
    <div class="location-bg">
        <div class="location-circle location-circle-1"></div>
        <div class="location-circle location-circle-2"></div>
    </div>

    <div class="container">
        <h2 class="sections-heading">Upload Documents</h2>
        <div class="location-content">
            <div class="location-text fade-in" style="flex:1 1 50%;">
                <div id="upload-card" style="border:2px dashed #cbd5f5;border-radius:18px;padding:2rem 1.5rem;text-align:center;background:#f9fbff;cursor:pointer;">
                    <i class="fas fa-cloud-upload-alt" style="font-size:2.3rem;color:#4f46e5;margin-bottom:1rem;"></i>
                    <h3 style="margin:0 0 0.5rem;">Upload Blank Forms</h3>
                    <p style="margin:0 0 1rem;font-size:0.9rem;color:#64748b;">Drag & drop your documents here or click to browse files</p>
                    <button id="select-files-btn" class="btn-location" type="button">Select Files</button>
                    <input id="file-input" type="file" multiple style="display:none;" accept=".txt,.md,.rtf,.html,.pdf,.doc,.docx,.png,.jpg,.jpeg">
                </div>

                <div id="files-list" style="margin-top:1.5rem;display:flex;flex-direction:column;gap:0.75rem;"></div>

                <div style="margin-top:1.5rem;display:flex;align-items:center;gap:1rem;flex-wrap:wrap;">
                    <button id="fill-docs-btn" class="btn-location" type="button">
                        <i class="fas fa-magic"></i> Fill Documents Automatically
                    </button>
                    <button id="clear-all-btn" class="btn-location" type="button" style="background:#e5e7eb;color:#111827;">
                        <i class="fas fa-trash"></i> Clear All
                    </button>
                    <span id="fill-status" style="font-size:0.85rem;color:#4b5563;"></span>
                </div>
                <p class="location-note" style="margin-top:0.75rem;">For best results upload exactly two files: the blank form and your document with personal data.</p>
            </div>

            <div class="location-visual fade-in" style="flex:1 1 50%;display:flex;flex-direction:column;gap:1rem;">
                <div class="location-map" style="min-height:160px;display:flex;flex-direction:column;align-items:stretch;justify-content:flex-start;padding:0;">
                    <div style="padding:1rem 1.5rem;border-bottom:1px solid rgba(148,163,184,0.3);display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <h3 style="margin:0;font-size:1rem;">Document Preview</h3>
                            <p style="margin:0.25rem 0 0;font-size:0.75rem;color:#6b7280;">Review the filled form and missing fields.</p>
                        </div>
                        <span id="preview-count" style="font-size:0.8rem;color:#4b5563;">0 documents</span>
                    </div>
                    <div style="flex:1 1 auto;padding:1rem 1.5rem;overflow:auto;">
                        <pre id="filled-text" style="white-space:pre-wrap;word-wrap:break-word;background:#f8fafc;border-radius:12px;padding:1rem;border:1px dashed #cbd5f5;min-height:220px;font-family:'Poppins',sans-serif;font-size:13px;color:#0f172a;">Waiting for documents...</pre>
                    </div>
                    <div style="padding:0.75rem 1.5rem;border-top:1px solid rgba(148,163,184,0.3);display:flex;flex-direction:column;gap:0.5rem;">
                        <div>
                            <strong style="font-size:0.85rem;">Missing fields</strong>
                            <ul id="missing-fields-list" style="margin:0.25rem 0 0;padding-left:1.25rem;font-size:0.8rem;color:#6b7280;"></ul>
                        </div>
                        <div>
                            <strong style="font-size:0.85rem;">Notes</strong>
                            <p id="notes-text" style="margin:0.25rem 0 0;font-size:0.8rem;color:#6b7280;">No notes yet.</p>
                        </div>
                        <div style="margin-top:0.25rem;display:flex;gap:0.75rem;flex-wrap:wrap;">
                            <button id="copy-filled-btn" class="btn-location" type="button">
                                <i class="fas fa-copy"></i> Copy Filled Text
                            </button>
                            <button id="download-filled-btn" class="btn-location" type="button">
                                <i class="fas fa-download"></i> Download As TXT
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<footer class="footer">
    <div class="container">
        <h2>Let AI Handle Your Paperwork</h2>
        <p>Stop rewriting the same data again and again. Upload your documents once and let UrbanMind fill the forms for you.</p>
        <a href="#documents-section" class="btn-footer">Try Now</a>
    </div>
</footer>

<script>
    console.log('banking page script loaded');

    fetch('/header.html')
        .then(function(response) {
            if (!response.ok) {
                throw new Error('HTTP error ' + response.status);
            }
            return response.text();
        })
        .then(function(html) {
            document.getElementById('header-container').innerHTML = html;
        })
        .catch(function(error) {
            document.getElementById('header-container').innerHTML =
                '<div style="color: red;">Error loading header: ' + error.message + '</div>';
        });

    (function() {
        console.log('init banking page logic');

        var mobileMenuBtn = document.getElementById('mobile-menu-btn');
        var navMenu = document.getElementById('nav-menu');
        if (mobileMenuBtn && navMenu) {
            mobileMenuBtn.addEventListener('click', function() {
                navMenu.classList.toggle('active');
            });
        }

        var fileInput = document.getElementById('file-input');
        var selectFilesBtn = document.getElementById('select-files-btn');
        var uploadCard = document.getElementById('upload-card');
        var filesList = document.getElementById('files-list');
        var fillDocsBtn = document.getElementById('fill-docs-btn');
        var clearAllBtn = document.getElementById('clear-all-btn');
        var fillStatus = document.getElementById('fill-status');
        var filledText = document.getElementById('filled-text');
        var missingFieldsList = document.getElementById('missing-fields-list');
        var notesText = document.getElementById('notes-text');
        var copyFilledBtn = document.getElementById('copy-filled-btn');
        var downloadFilledBtn = document.getElementById('download-filled-btn');
        var previewCount = document.getElementById('preview-count');

        console.log('elements:', {
            fileInput: !!fileInput,
            selectFilesBtn: !!selectFilesBtn,
            uploadCard: !!uploadCard,
            fillDocsBtn: !!fillDocsBtn,
            clearAllBtn: !!clearAllBtn
        });

        var uploadedFiles = [];

        function renderFiles() {
            filesList.innerHTML = '';
            if (!uploadedFiles.length) {
                previewCount.textContent = '0 documents';
                return;
            }
            previewCount.textContent = uploadedFiles.length + ' document' + (uploadedFiles.length > 1 ? 's' : '');
            uploadedFiles.forEach(function(file, idx) {
                var row = document.createElement('div');
                row.style.display = 'flex';
                row.style.alignItems = 'center';
                row.style.justifyContent = 'space-between';
                row.style.padding = '0.75rem 1rem';
                row.style.borderRadius = '12px';
                row.style.background = '#f9fafb';

                var left = document.createElement('div');
                left.style.display = 'flex';
                left.style.alignItems = 'center';
                left.style.gap = '0.75rem';

                var iconBox = document.createElement('div');
                iconBox.style.width = '32px';
                iconBox.style.height = '32px';
                iconBox.style.borderRadius = '10px';
                iconBox.style.background = '#22c55e';
                iconBox.style.display = 'flex';
                iconBox.style.alignItems = 'center';
                iconBox.style.justifyContent = 'center';
                iconBox.style.color = 'white';
                var icon = document.createElement('i');
                icon.className = 'fas fa-file-alt';
                iconBox.appendChild(icon);

                var info = document.createElement('div');
                var title = document.createElement('div');
                title.textContent = file.name;
                title.style.fontSize = '0.86rem';
                title.style.fontWeight = '500';
                var size = document.createElement('div');
                size.style.fontSize = '0.75rem';
                size.style.color = '#6b7280';
                size.textContent = Math.round(file.size / 1024) + ' KB';
                info.appendChild(title);
                info.appendChild(size);

                left.appendChild(iconBox);
                left.appendChild(info);

                var right = document.createElement('button');
                right.textContent = 'Remove';
                right.style.border = 'none';
                right.style.borderRadius = '999px';
                right.style.padding = '0.2rem 0.7rem';
                right.style.fontSize = '0.75rem';
                right.style.background = '#fee2e2';
                right.style.color = '#b91c1c';
                right.style.cursor = 'pointer';
                right.addEventListener('click', function() {
                    uploadedFiles.splice(idx, 1);
                    renderFiles();
                });

                row.appendChild(left);
                row.appendChild(right);
                filesList.appendChild(row);
            });
        }

        function handleFiles(files) {
            for (var i = 0; i < files.length; i++) {
                uploadedFiles.push(files[i]);
            }
            console.log('files added:', uploadedFiles.map(function(f) { return f.name; }));
            renderFiles();
        }

        if (selectFilesBtn && fileInput) {
            selectFilesBtn.addEventListener('click', function() {
                console.log('select files clicked');
                fileInput.click();
            });
            fileInput.addEventListener('change', function() {
                if (fileInput.files && fileInput.files.length) {
                    console.log('file input change, count=', fileInput.files.length);
                    handleFiles(fileInput.files);
                    fileInput.value = '';
                }
            });
        }

        if (uploadCard) {
            uploadCard.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                uploadCard.style.background = '#eef2ff';
            });
            uploadCard.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                uploadCard.style.background = '#f9fbff';
            });
            uploadCard.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                uploadCard.style.background = '#f9fbff';
                if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length) {
                    console.log('files dropped, count=', e.dataTransfer.files.length);
                    handleFiles(e.dataTransfer.files);
                }
            });
        }

        function setLoading(isLoading, count) {
            if (isLoading) {
                fillDocsBtn.disabled = true;
                clearAllBtn.disabled = true;
                fillDocsBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Filling...';
                fillStatus.style.color = '#2563eb';
                var c = count || uploadedFiles.length || 0;
                fillStatus.textContent = 'Processing ' + c + ' document' + (c !== 1 ? 's' : '') + '...';
                filledText.textContent = 'Processing ' + c + ' document' + (c !== 1 ? 's' : '') + '...';
            } else {
                fillDocsBtn.disabled = false;
                clearAllBtn.disabled = false;
                fillDocsBtn.innerHTML = '<i class="fas fa-magic"></i> Fill Documents Automatically';
            }
        }

        function callFillForm() {
            console.log('callFillForm invoked, uploadedFiles.length=', uploadedFiles.length);
            if (uploadedFiles.length < 2) {
                fillStatus.style.color = '#b91c1c';
                fillStatus.textContent = 'Upload at least two documents: blank form and your document.';
                return;
            }
            var first = uploadedFiles[0];
            var second = uploadedFiles[1];
            console.log('sending files to backend:', first.name, second.name);
            setLoading(true, 2);

            var formData = new FormData();
            formData.append('template_file', first);
            formData.append('user_document_file', second);
            formData.append('language', 'en');

            fetch('/api/fill_form', {
                method: 'POST',
                body: formData
            })
                .then(function(res) {
                    console.log('response from /api/fill_form status=', res.status);
                    if (!res.ok) {
                        throw new Error('HTTP error ' + res.status);
                    }
                    return res.json();
                })
                .then(function(data) {
                    console.log('data from backend:', data);
                    filledText.textContent = data.filled_text || '';
                    missingFieldsList.innerHTML = '';
                    if (data.missing_fields && data.missing_fields.length) {
                        data.missing_fields.forEach(function(field) {
                            var li = document.createElement('li');
                            li.textContent = field;
                            missingFieldsList.appendChild(li);
                        });
                    } else {
                        var li = document.createElement('li');
                        li.textContent = 'No obvious missing fields detected.';
                        missingFieldsList.appendChild(li);
                    }
                    if (data.notes) {
                        notesText.textContent = data.notes;
                    } else {
                        notesText.textContent = 'The form was filled based on the available data.';
                    }
                    fillStatus.style.color = '#16a34a';
                    fillStatus.textContent = 'Completed. Review the result on the right.';
                    previewCount.textContent = '1 document';
                })
                .catch(function(err) {
                    console.error('error in fetch /api/fill_form:', err);
                    fillStatus.style.color = '#b91c1c';
                    fillStatus.textContent = 'Error: ' + err.message;
                    filledText.textContent = 'An error occurred while filling the form.';
                })
                .finally(function() {
                    setLoading(false);
                });
        }

        if (fillDocsBtn) {
            console.log('binding click handler to fillDocsBtn');
            fillDocsBtn.addEventListener('click', function() {
                console.log('fillDocsBtn clicked');
                callFillForm();
            });
        } else {
            console.log('fillDocsBtn not found');
        }

        if (clearAllBtn) {
            clearAllBtn.addEventListener('click', function() {
                console.log('clearAll clicked');
                uploadedFiles = [];
                renderFiles();
                filledText.textContent = 'Waiting for documents...';
                missingFieldsList.innerHTML = '';
                notesText.textContent = 'No notes yet.';
                fillStatus.textContent = '';
            });
        }

        if (copyFilledBtn) {
            copyFilledBtn.addEventListener('click', function() {
                var text = filledText.textContent || '';
                if (!text) return;
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text).then(function() {
                        fillStatus.style.color = '#16a34a';
                        fillStatus.textContent = 'Filled text copied to clipboard.';
                    }).catch(function() {});
                }
            });
        }

        if (downloadFilledBtn) {
            downloadFilledBtn.addEventListener('click', function() {
                var text = filledText.textContent || '';
                if (!text) return;
                var blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'filled_form.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        }
    })();
</script>
</body>
</html>
